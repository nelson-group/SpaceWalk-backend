# How to prepare the necessary data

In order to use the application the backend needs access to preprocessed data.
This data is generated by the preprocessing pipeline, which can be started via
the `tng-sv-cli`.

As it relates to the web application we can find this preprocessing command
under the `web` subcommand. Additionally, one has to set the API token, required
to download the data. Given the data is already present, one can also set the
`--data-path` flag.

To see which flags exists use:
```
$ tng-sv-cli web preprocess --help  # For preprocessing one snapshot
$ tng-sv-cli web batch-preprocess --help  # For preprocessing multiple snapshots
```

Not so straight forward parameters are:

- `--filter-out-percentage`, which allows to only pre-process a certain
    percentage of the data, sorted by max value
- `--data-path`, which allows to use already present data on the machine, if
    e.g. the CLI is executed on a host from the IllustrisTNG project

## The pipeline

- **Download snapshot n and n+1**: To pre-process a snapshot, meaning an instant
  in time, the tool downloads the current snapshot and the next one. As we
  interpolate the trajectory from one particle at two time frames we require the
  positions at time n and n+1.
- **Filter out a specific percentage**: Allows to filter out a certain
  percentage of data points based on a certain property ordered by size, e.g.
  Density
- **Check which particles are contained in both snapshots**
- **Generate an Octree based on the particles which we can interpolate**:
    The octree contains the offsets to the splines, which are stored in an extra
    array. This is done for pragmatic performance reasons. The octree serializes
    to json, while saving the extra array can be done using numpy arrays. Which
    makes reading and accessing faster compared to dumping everything as a json
    file.
    * We use the Python API of the C++ Open3D implementation of an Octree
- For the spline calculation we refactored the [CubicHermiteSpline](https://docs.scipy.org/doc/scipy/reference/generated/scipy.interpolate.CubicHermiteSpline.html ) of SciPy, s.t. we can use numba's JIT feature in order to speed up the pipeline.
- **Calculate further properties**:
    * Attribute Quantiles: allows a better user experience when filtering out
      certain quantiles of an attribute in the
    * **Voronoi diameter**: Is an approximation of the size of certain voronoi
        cells using the known density and mass of a cell
- **Save data to the disk**
